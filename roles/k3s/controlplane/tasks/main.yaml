---

### First Controlplane Node
- name: Setup First Controlplane Node
  block:

  - name: Download k3s binary x64
    get_url:
      url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
      checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt
      dest: /usr/local/bin/k3s
      owner: root
      group: root
      mode: 0755
    notify:
    - restart_k3s.service
    when:
    - ansible_facts.architecture == "x86_64"

  - name: Copy K3s service file
    register: k3s_service
    template:
      src: "k3s.service.j2"
      dest: "{{ systemd_dir }}/k3s.service"
      owner: root
      group: root
      mode: 0644

  - name: Restart k3s service
    systemd:
      name: k3s
      daemon_reload: yes
      state: restarted
      enabled: yes
    when: k3s_service is changed

  - name: Install Cilium
    template:
      src: "cilium.yaml.j2"
      dest: "/var/lib/rancher/k3s/server/manifests/cilium.yaml"
      owner: root
      group: root
      mode: 0644

  - name: Install Kube-vip
    template:
      src: "kube-vip.yaml.j2"
      dest: "/var/lib/rancher/k3s/server/manifests/kube-vip.yaml"
      owner: root
      group: root
      mode: 0644

  - name: Wait until kube-vip is ready to accept connections
    wait_for:
      host: "{{ apiserver_endpoint }}"
      port: 6443

  when: 
  - ansible_host == groups['controlplanes'][0]

### Additional Controlplane Nodes
- name: Setup Additional Controlplane Node
  block:

  - name: Download k3s binary x64
    get_url:
      url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
      checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt
      dest: /usr/local/bin/k3s
      owner: root
      group: root
      mode: 0755
    notify:
    - restart_k3s.service
    when: 
    - ansible_facts.architecture == "x86_64"

  - name: Copy K3s service file
    register: k3s_service
    template:
      src: "k3s.service.j2"
      dest: "{{ systemd_dir }}/k3s.service"
      owner: root
      group: root

  - name: Reload systemd
    systemd:
      name: k3s
      daemon_reload: yes
      enabled: yes
    notify: 
    - restart_k3s.service
    when: 
    - k3s_service is changed
    
  when: ansible_host != groups['controlplanes'][0]

### All Controlplane Nodes
- name: Create kubectl symlink
  file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link

- name: Create crictl symlink
  file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/crictl
    state: link